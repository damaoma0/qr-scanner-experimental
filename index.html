<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Attendance Scanner</title>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video { width: 100%; max-width: 400px; }
    #feedback { font-size: 3em; margin: 20px; }
    .check { color: green; }
    .cross { color: red; }
    #attendance { list-style: none; padding: 0; }
    #attendance li.attended { color: green; }
  </style>
</head>
<body>
  <h1>Scan Your QR Code</h1>
  <video id="video" autoplay muted playsinline style="border:1px solid #ccc; width:100%; max-width:400px; background:#000;" ></video>
  <canvas id="canvas" hidden></canvas> id="canvas" hidden></canvas>
  <div id="feedback"></div>
  <h2>Checked-in Guests</h2>
  <ul id="attendance"></ul>

  <script>
  let tokensMap = {};
  let seen = new Set();

  fetch('tokens.json')
    .then(res => res.json())
    .then(data => { tokensMap = data; startCamera(); });

  function startCamera() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => { document.getElementById('video').srcObject = stream; tick(); });
  }

  function tick() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imgData.data, imgData.width, imgData.height);
      if (code && code.data) {
        verifyToken(code.data.trim());
      }
    }
    requestAnimationFrame(tick);
  }

  async function verifyToken(raw) {
    const feedback = document.getElementById('feedback');
    const buf = new TextEncoder().encode(raw);
    const hashBuf = await crypto.subtle.digest('SHA-256', buf);
    const hashArray = Array.from(new Uint8Array(hashBuf));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

    if (tokensMap[hashHex] && !seen.has(hashHex)) {
      seen.add(hashHex);
      feedback.textContent = '✔️';
      feedback.className = 'check';
      const li = document.createElement('li');
      li.textContent = tokensMap[hashHex];
      li.classList.add('attended');
      document.getElementById('attendance').appendChild(li);
    } else {
      feedback.textContent = '❌';
      feedback.className = 'cross';
    }

    setTimeout(() => { feedback.textContent = ''; }, 1000);
  }
  </script>
</body>
</html>
